# Event Handling Capability

## ADDED Requirements

### Requirement: Keyboard Event Interception

The system SHALL intercept keyboard events system-wide using macOS CGEventTap.

#### Scenario: Event tap initialization
- **WHEN** application starts
- **AND** accessibility permissions are granted
- **THEN** CGEventTap is created for keyboard events

#### Scenario: Event capture
- **WHEN** user presses a key in any application
- **THEN** the event is captured by OpenKey before reaching the target application

#### Scenario: Own event filtering
- **WHEN** an event is generated by OpenKey itself
- **THEN** the event is passed through without processing

---

### Requirement: Keyboard Event Processing

The system SHALL process keyboard events and determine appropriate action.

#### Scenario: Vietnamese mode key processing
- **WHEN** Vietnamese mode is active
- **AND** a key is pressed
- **THEN** the key is sent to Vietnamese engine for processing

#### Scenario: English mode passthrough
- **WHEN** English mode is active
- **AND** a key is pressed
- **THEN** the key is passed through unchanged

#### Scenario: Mouse event session reset
- **WHEN** a mouse click or drag event occurs
- **THEN** current typing session is reset

---

### Requirement: Text Output Injection

The system SHALL inject processed text back to applications.

#### Scenario: Backspace injection
- **WHEN** Vietnamese processing requires character replacement
- **THEN** appropriate number of backspace events are sent first

#### Scenario: Unicode character injection
- **WHEN** new characters need to be output
- **THEN** Unicode characters are injected using CGEventKeyboardSetUnicodeString

---

### Requirement: Hotkey Handling

The system SHALL respond to configurable hotkeys.

#### Scenario: Language switch hotkey
- **WHEN** user presses language switch hotkey (e.g., Ctrl+Space)
- **THEN** input language toggles between Vietnamese and English

#### Scenario: Hotkey customization
- **WHEN** user configures custom hotkey in settings
- **THEN** the new hotkey is recognized

---

### Requirement: Application Compatibility

The system SHALL handle application-specific quirks for compatibility.

#### Scenario: Browser autocomplete handling
- **WHEN** typing in Chrome, Safari, or other browsers
- **AND** autocomplete may interfere
- **THEN** special handling is applied (empty character, shift+arrow, etc.)

#### Scenario: Sublime Text compatibility
- **WHEN** typing in Sublime Text
- **THEN** special empty character handling is applied

---

### Requirement: Accessibility Permission Management

The system SHALL manage accessibility permissions properly.

#### Scenario: Permission check on startup
- **WHEN** application starts
- **THEN** accessibility permission status is checked

#### Scenario: Permission not granted
- **WHEN** accessibility permission is not granted
- **THEN** user is prompted to grant permission
- **AND** application cannot process keyboard events until granted

#### Scenario: Permission granted
- **WHEN** accessibility permission is granted
- **THEN** event tap is initialized and keyboard processing begins

---

### Requirement: Keyboard Layout Compatibility

The system SHALL support different keyboard layouts.

#### Scenario: Layout conversion
- **WHEN** keyboard layout compatibility is enabled
- **AND** non-standard layout is detected
- **THEN** key codes are converted to standard positions

#### Scenario: Layout-independent operation
- **WHEN** user switches keyboard layout
- **THEN** Vietnamese input continues to work correctly
