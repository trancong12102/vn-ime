## MODIFIED Requirements

### Requirement: Keyboard Event Interception

The system SHALL intercept keyboard events system-wide using macOS CGEventTap.

#### Scenario: Event tap initialization
- **WHEN** application starts
- **AND** accessibility permissions are granted
- **THEN** CGEventTap is created for keyboard and mouse events
- **AND** a private CGEventSource is created for own-event identification

#### Scenario: Event capture
- **WHEN** user presses a key in any application
- **THEN** the event is captured by LotusKey before reaching the target application

#### Scenario: Own event filtering
- **WHEN** an event is generated by LotusKey itself
- **THEN** the event is passed through without processing
- **AND** infinite loops are prevented by comparing source state IDs

#### Scenario: Event tap recovery
- **WHEN** event tap is disabled by system timeout
- **THEN** the tap is automatically re-enabled

#### Scenario: Mouse event detection
- **WHEN** a mouse click or drag event occurs
- **THEN** the event is detected by the event tap
- **AND** the event is passed through unchanged after session reset

---

### Requirement: Keyboard Event Processing

The system SHALL process keyboard events and determine appropriate action.

#### Scenario: Vietnamese mode key processing
- **WHEN** Vietnamese mode is active
- **AND** a key is pressed without control modifiers (except Shift)
- **THEN** the key is sent to Vietnamese engine for processing

#### Scenario: English mode passthrough
- **WHEN** English mode is active
- **AND** a key is pressed
- **THEN** the key is passed through unchanged

#### Scenario: Mouse event session reset
- **WHEN** a mouse click or drag event occurs
- **THEN** current typing session is reset via engine
- **AND** typing buffer is cleared

#### Scenario: Other control key bypass
- **WHEN** a key is pressed with Command, Control, or Option modifier
- **THEN** the key is passed through unchanged
- **AND** Vietnamese processing is skipped

#### Scenario: Temporary engine disable
- **WHEN** Command key is held down
- **THEN** Vietnamese processing is temporarily bypassed
- **AND** all keys pass through unchanged until Command is released

---

### Requirement: Text Output Injection

The system SHALL inject processed text back to applications using CGEventTapPostEvent.

#### Scenario: Backspace injection
- **WHEN** Vietnamese processing requires character replacement
- **THEN** appropriate number of backspace events are sent first
- **AND** events are created with private event source
- **AND** events are posted via CGEventTapPostEvent for reliability

#### Scenario: Unicode character injection (batch mode)
- **WHEN** new characters need to be output
- **AND** batch mode is enabled (default)
- **THEN** up to 16 Unicode characters are injected per event
- **AND** strings longer than 16 chars are sent in multiple batches

#### Scenario: Unicode character injection (step-by-step mode)
- **WHEN** new characters need to be output
- **AND** step-by-step mode is enabled
- **THEN** each character is injected as a separate keyboard event

#### Scenario: Empty character injection
- **WHEN** application requires special handling for autocomplete
- **THEN** appropriate empty character is injected before backspaces
- **AND** NNBSP (0x202F) is used by default
- **AND** ZWNJ (0x200C) is used for Sublime Text

---

### Requirement: Hotkey Handling

The system SHALL respond to configurable hotkeys.

#### Scenario: Language switch hotkey
- **WHEN** user presses language switch hotkey (default: Option+Z)
- **THEN** input language toggles between Vietnamese and English
- **AND** optional beep sound is played

#### Scenario: Hotkey customization
- **WHEN** user configures custom hotkey in settings
- **THEN** the new hotkey is recognized using bitfield format

#### Scenario: Hotkey event consumption
- **WHEN** a hotkey is matched
- **THEN** the event is consumed (not passed to application)

---

### Requirement: Application Compatibility

The system SHALL handle application-specific quirks for compatibility.

#### Scenario: Browser autocomplete handling
- **WHEN** typing in Chrome, Safari, or other browsers
- **AND** autocomplete may interfere
- **THEN** empty character is injected before backspaces

#### Scenario: Sublime Text compatibility
- **WHEN** typing in Sublime Text
- **THEN** ZWNJ (0x200C) is used instead of NNBSP for empty character

#### Scenario: Chromium browser workaround
- **WHEN** typing in Chrome, Brave, or Edge
- **AND** standard backspace has issues
- **THEN** Shift+Left Arrow method is used to select characters
- **AND** selected text is replaced by new characters

#### Scenario: Application detection
- **WHEN** frontmost application changes
- **THEN** bundle identifier is detected via NSWorkspace
- **AND** appropriate quirk handling is selected based on prefix matching

---

### Requirement: Accessibility Permission Management

The system SHALL manage accessibility permissions properly.

#### Scenario: Permission check on startup
- **WHEN** application starts
- **THEN** accessibility permission status is checked via AXIsProcessTrusted()

#### Scenario: Permission not granted
- **WHEN** accessibility permission is not granted
- **THEN** user is shown permission request dialog
- **AND** dialog includes button to open System Settings
- **AND** application cannot process keyboard events until granted

#### Scenario: Permission granted
- **WHEN** accessibility permission is granted
- **THEN** event tap is initialized and keyboard processing begins

---

### Requirement: Keyboard Layout Compatibility

The system SHALL support different keyboard layouts.

#### Scenario: Layout conversion
- **WHEN** keyboard layout compatibility is enabled
- **AND** non-QWERTY layout is detected
- **THEN** physical key codes are converted to logical characters
- **AND** NSEvent.charactersIgnoringModifiers is used for mapping

#### Scenario: Layout-independent operation
- **WHEN** user switches keyboard layout
- **THEN** Vietnamese input continues to work correctly
- **AND** fallback to physical key code is used if mapping fails

---

## ADDED Requirements

### Requirement: Text Injector Component

The system SHALL provide a dedicated component for text injection with application-aware behavior.

#### Scenario: Injector initialization
- **WHEN** KeyboardEventHandler is created
- **THEN** TextInjector is initialized with private event source
- **AND** pre-created backspace events are prepared for performance

#### Scenario: App-specific injection
- **WHEN** text needs to be injected
- **THEN** TextInjector checks current application bundle ID
- **AND** applies appropriate injection method based on quirk registry

#### Scenario: Quirk registry lookup
- **WHEN** injection method is needed
- **THEN** application bundle ID is matched against known quirks
- **AND** prefix matching is used for flexibility
- **AND** default behavior is used for unknown applications

---

### Requirement: Other Language Input Source Detection

The system SHALL detect and respect other language input methods.

#### Scenario: Input source check
- **WHEN** keyboard event is received
- **AND** other language bypass is enabled
- **THEN** current system input source language is checked via TIS

#### Scenario: Non-English input source active
- **WHEN** a non-English input method is active (Japanese, Chinese, Korean, etc.)
- **THEN** Vietnamese processing is bypassed
- **AND** all keyboard events pass through unchanged

#### Scenario: English input source active
- **WHEN** English input source is active
- **THEN** normal Vietnamese processing proceeds

---

### Requirement: Modifier Key Tracking

The system SHALL track modifier key states for proper processing.

#### Scenario: Modifier extraction
- **WHEN** keyboard event is received
- **THEN** modifier flags are extracted (Shift, Control, Command, Option, Caps Lock)

#### Scenario: Caps status detection
- **WHEN** determining character capitalization
- **THEN** Shift key results in capsStatus = 1
- **AND** Caps Lock results in capsStatus = 2
- **AND** capsStatus is passed to engine for proper character generation

#### Scenario: FlagsChanged event handling
- **WHEN** modifier key state changes
- **THEN** event is processed for hotkey detection
- **AND** temporary disable states are updated
